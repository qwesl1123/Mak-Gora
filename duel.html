<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mak'Gora - Classic</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet" />

    <style>
      :root {
        --stone-dark: #1a1410;
        --stone-med: #2d2620;
        --stone-light: #4a423a;
        --gold: #ffd700;
        --gold-dark: #d4af37;
        --bronze: #cd7f32;
        --health-red: #cc3333;
        --mana-blue: #3385cc;
        --rage-red: #8b1a1a;
        --energy-yellow: #ffcc00;
        --text-light: #f4e4c1;
        --text-dark: #c9b896;
        --border-gold: #8b7355;
        --warrior-color: #C69B6D;
        --mage-color: #3FC7EB;
        --rogue-color: #FFF468;
        --item-green: #1eff00;
        --item-blue: #0070dd;
        --item-purple: #a335ee;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        background:
          linear-gradient(
            135deg,
            rgba(10, 8, 6, 0.55) 0%,
            rgba(10, 8, 6, 0.65) 100%
          ),
          url("/static/art/duel.webp");

        background-size: cover;
        background-position: center;
        background-attachment: fixed;

        color: var(--text-light);
        font-family: 'Crimson Text', serif;
        min-height: 100vh;
        padding: 20px;
      }


      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: linear-gradient(180deg, var(--stone-med) 0%, var(--stone-dark) 100%);
        border: 3px solid var(--bronze);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 
          0 0 30px rgba(255, 215, 0, 0.3),
          inset 0 2px 0 rgba(255, 215, 0, 0.2),
          inset 0 -2px 0 rgba(0, 0, 0, 0.5);
      }

      h1 {
        font-family: 'Cinzel', serif;
        font-size: 3.5rem;
        color: var(--gold);
        text-shadow: 
          0 0 20px rgba(255, 215, 0, 0.8),
          2px 2px 4px rgba(0, 0, 0, 0.8),
          0 0 40px rgba(255, 215, 0, 0.4);
        letter-spacing: 0.15em;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 1.3rem;
        color: var(--text-dark);
        letter-spacing: 0.05em;
      }

      .status-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-gold);
        border-radius: 5px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #888;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }

      .status-dot.connected {
        background: #44ff44;
        box-shadow: 0 0 15px rgba(68, 255, 68, 0.7);
      }

      .grid {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 20px;
      }

      @media (max-width: 1200px) {
        .grid { grid-template-columns: 1fr; }
      }

      .panel {
        background: linear-gradient(180deg, var(--stone-med) 0%, var(--stone-dark) 100%);
        border: 3px solid var(--bronze);
        border-radius: 8px;
        box-shadow: 
          0 8px 20px rgba(0, 0, 0, 0.6),
          inset 0 2px 0 rgba(255, 215, 0, 0.15);
      }

      .panel-header {
        background: linear-gradient(180deg, var(--stone-light) 0%, var(--stone-med) 100%);
        border-bottom: 2px solid var(--bronze);
        padding: 15px 20px;
        font-family: 'Cinzel', serif;
        font-size: 1.4rem;
        color: var(--gold);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .panel-body {
        padding: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.6) 100%);
        border: 2px solid var(--border-gold);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
      }

      .stat-title {
        font-family: 'Cinzel', serif;
        font-size: 1.3rem;
        color: var(--gold-dark);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        padding-bottom: 8px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 1.1rem;
        color: var(--text-dark);
      }

      .stat-row strong {
        color: var(--text-light);
        font-weight: 600;
      }

      .status-text {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .status-text.stealthed {
        color: var(--rogue-color);
      }

      .resource-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
      }

      .bar-container {
        flex: 1;
        height: 20px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-gold);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
        display: flex;
      }

      .bar-fill {
        height: 100%;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .bar-fill.health {
        background: linear-gradient(180deg, #ff4444 0%, #cc0000 100%);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
      }

      .bar-fill.health.hp-dead {
        background: #000;
        box-shadow: none;
      }

      .bar-fill.absorb {
        background: #ffffff;
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6);
      }

      .bar-fill.mana {
        background: linear-gradient(180deg, #4488ff 0%, #0044cc 100%);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
      }

      .bar-fill.energy {
        background: linear-gradient(180deg, #ffff44 0%, #cccc00 100%);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
      }

      .bar-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.85rem;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        z-index: 1;
        width: 100%;
        text-align: center;
      }

      button {
        background: linear-gradient(180deg, var(--stone-light) 0%, var(--stone-med) 100%);
        border: 2px solid var(--bronze);
        color: var(--text-light);
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Crimson Text', serif;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 215, 0, 0.2);
      }

      button:hover {
        background: linear-gradient(180deg, #5a5248 0%, var(--stone-light) 100%);
        border-color: var(--gold-dark);
        transform: translateY(-2px);
        box-shadow: 
          0 6px 12px rgba(0, 0, 0, 0.5),
          0 0 20px rgba(255, 215, 0, 0.3);
      }

      button:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: linear-gradient(180deg, var(--gold-dark) 0%, var(--bronze) 100%);
        border-color: var(--gold);
        color: var(--stone-dark);
      }

      .btn-primary:hover {
        background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%);
        box-shadow: 
          0 6px 12px rgba(0, 0, 0, 0.5),
          0 0 25px rgba(255, 215, 0, 0.6);
      }

      input[type="text"] {
        width: 100%;
        padding: 12px 15px;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid var(--border-gold);
        border-radius: 5px;
        color: var(--text-light);
        font-family: 'Crimson Text', serif;
        font-size: 1.1rem;
        outline: none;
      }

      input[type="text"]:focus {
        border-color: var(--gold-dark);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
      }

      .combat-log {
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid var(--border-gold);
        border-radius: 6px;
        height: 750px;
        overflow-y: auto;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.6;
      }

      .combat-log::-webkit-scrollbar {
        width: 12px;
      }

      .combat-log::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 6px;
      }

      .combat-log::-webkit-scrollbar-thumb {
        background: var(--bronze);
        border-radius: 6px;
        border: 2px solid rgba(0, 0, 0, 0.5);
      }

      /* Chat Section */
      .chat-section {
        margin-top: 20px;
      }

      .chat-header {
        font-family: 'Cinzel', serif;
        font-size: 1.1rem;
        color: var(--gold-dark);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .chat-box {
        background: rgba(0, 0, 0, 0.7);
        border: 3px solid #44ff44;
        border-radius: 6px;
        height: 300px;
        overflow-y: auto;
        padding: 12px;
        font-family: 'Arial', sans-serif;
        font-size: 1rem;
        line-height: 1.5;
        box-shadow: 
          0 0 20px rgba(68, 255, 68, 0.3),
          inset 0 0 10px rgba(68, 255, 68, 0.1);
      }

      .chat-box::-webkit-scrollbar {
        width: 10px;
      }

      .chat-box::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 5px;
      }

      .chat-box::-webkit-scrollbar-thumb {
        background: #44ff44;
        border-radius: 5px;
        border: 2px solid rgba(0, 0, 0, 0.5);
      }

      .chat-message {
        margin-bottom: 8px;
        padding: 4px 0;
      }

      .chat-message.friendly {
        color: #44ff44;
      }

      .chat-message.enemy {
        color: #ff4444;
      }

      .chat-message .chat-player {
        font-weight: bold;
        margin-right: 8px;
      }

      .chat-input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        margin-top: 10px;
      }

      .chat-input-group input {
        padding: 10px 12px;
        font-size: 1rem;
      }

      .chat-input-group button {
        padding: 10px 20px;
      }

      .log-line {
        margin-bottom: 6px;
        padding: 3px 0;
      }

      .logLineSystem {
        color: var(--gold-dark);
      }

      .logLineTurn {
        color: #ffaa44;
      }

      .logLineTurnHeader {
        color: #ffffff;
        font-size: 1.4em;
        font-weight: 700;
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.85);
      }

      .logLineProc {
        color: var(--gold);
        font-weight: 700;
        text-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
      }

      .logLineAmbush {
        color: var(--rogue-color);
        font-weight: 700;
        text-shadow: 0 0 12px rgba(255, 244, 104, 0.95);
      }

      .logLineExecute {
        color: #ff4444;
        font-weight: 700;
        text-shadow: 0 0 12px rgba(255, 68, 68, 0.85);
      }

      .logLineOutcome {
        font-size: 2em;
        font-weight: 700;
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
      }

      .logLineChat {
        color: #88ddff;
      }

      .log-class-warrior,
      .log-ability-warrior {
        color: var(--warrior-color);
        font-weight: 700;
      }

      .log-class-mage,
      .log-ability-mage {
        color: var(--mage-color);
        font-weight: 700;
      }

      .log-class-rogue,
      .log-ability-rogue {
        color: var(--rogue-color);
        font-weight: 700;
      }

      .log-item-green {
        color: var(--item-green);
        font-weight: 700;
      }

      .log-item-blue {
        color: var(--item-blue);
        font-weight: 700;
      }

      .log-item-purple {
        color: var(--item-purple);
        font-weight: 700;
      }

      .controls {
        display: grid;
        gap: 10px;
        margin-top: 15px;
      }

      .input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
      }

      .hint {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-gold);
        border-radius: 5px;
        padding: 15px;
        margin-top: 15px;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-dark);
      }

      .kbd {
        display: inline-block;
        padding: 3px 8px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--bronze);
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: var(--gold);
      }

      /* Documentation Section */
      .documentation {
        max-width: 1400px;
        margin: 40px auto;
        background: linear-gradient(180deg, var(--stone-med) 0%, var(--stone-dark) 100%);
        border: 3px solid var(--bronze);
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      }

      .doc-title {
        font-family: 'Cinzel', serif;
        font-size: 2.5rem;
        color: var(--gold);
        text-align: center;
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .doc-section {
        margin-bottom: 30px;
      }

      .doc-section h3 {
        font-family: 'Cinzel', serif;
        font-size: 1.8rem;
        color: var(--gold-dark);
        margin-bottom: 15px;
        border-bottom: 2px solid var(--bronze);
        padding-bottom: 10px;
      }

      .doc-subtitle {
        font-family: 'Cinzel', serif;
        font-size: 1.4rem;
        color: var(--text-light);
        margin-top: 20px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .doc-content {
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--text-light);
      }

      .doc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }

      .doc-item {
        background: rgba(0, 0, 0, 0.4);
        border: 2px solid var(--border-gold);
        border-radius: 6px;
        padding: 15px;
      }

      .doc-item h4 {
        color: var(--gold);
        font-size: 1.3rem;
        margin-bottom: 10px;
        font-family: 'Cinzel', serif;
      }

      .doc-item p {
        color: var(--text-dark);
        font-size: 1rem;
        line-height: 1.6;
      }

      .doc-item .stat {
        color: var(--text-light);
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <a href="/" style="display:inline-block; margin-bottom:15px; color: var(--gold); text-decoration: none; font-size: 1.1rem; transition: color 0.3s;">
          ‚Üê Return to Main Hub
        </a>
        <h1>Mak'Gora</h1>
        <div class="subtitle">Trial by Combat - Turn-Based PvP</div>
        <div class="status-bar">
          <div class="status-indicator">
            <span id="connDot" class="status-dot"></span>
            <span id="connText">Disconnected</span>
          </div>
          <div class="status-indicator">
            <span id="roleText">Awaiting Match</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Left Panel: Controls & Stats -->
        <div class="panel">
          <div class="panel-header">War Council</div>
          <div class="panel-body">
            <!-- Friendly Stats -->
            <div class="stat-card">
              <h3 class="stat-title" id="friendlyLabel">Friendly Champion</h3>
              <div class="stat-row"><span>Weapon:</span><strong id="friendlyWeapon">--</strong></div>
              <div class="stat-row"><span>Armor:</span><strong id="friendlyArmor">--</strong></div>
              <div class="stat-row"><span>Trinket:</span><strong id="friendlyTrinket">--</strong></div>
              <div class="stat-row"><span>Status:</span><strong id="friendlyStatus" class="status-text">--</strong></div>
              
              <div class="resource-bar">
                <span style="width: 60px; color: var(--health-red); font-weight: bold;">HP</span>
                <div class="bar-container">
                  <div class="bar-text" id="friendlyHpText">--</div>
                  <div class="bar-fill health" id="friendlyHpBar" style="width: 100%;"></div>
                  <div class="bar-fill absorb" id="friendlyAbsorbBar" style="width: 0%;"></div>
                </div>
              </div>
              
              <div class="resource-bar">
                <span id="friendlyPrimaryLabel" style="width: 60px; color: var(--mana-blue); font-weight: bold;">Mana</span>
                <div class="bar-container">
                  <div class="bar-text" id="friendlyPrimaryText">--</div>
                  <div class="bar-fill" id="friendlyPrimaryBar" style="width: 100%;"></div>
                </div>
              </div>
              
            </div>

            <!-- Enemy Stats -->
            <div class="stat-card">
              <h3 class="stat-title" id="enemyLabel">Enemy Champion</h3>
              <div class="stat-row"><span>Weapon:</span><strong id="enemyWeapon">--</strong></div>
              <div class="stat-row"><span>Armor:</span><strong id="enemyArmor">--</strong></div>
              <div class="stat-row"><span>Trinket:</span><strong id="enemyTrinket">--</strong></div>
              <div class="stat-row"><span>Status:</span><strong id="enemyStatus" class="status-text">--</strong></div>
              
              <div class="resource-bar">
                <span style="width: 60px; color: var(--health-red); font-weight: bold;">HP</span>
                <div class="bar-container">
                  <div class="bar-text" id="enemyHpText">--</div>
                  <div class="bar-fill health" id="enemyHpBar" style="width: 100%;"></div>
                  <div class="bar-fill absorb" id="enemyAbsorbBar" style="width: 0%;"></div>
                </div>
              </div>
              
              <div class="resource-bar">
                <span id="enemyPrimaryLabel" style="width: 60px; color: var(--mana-blue); font-weight: bold;">Mana</span>
                <div class="bar-container">
                  <div class="bar-text" id="enemyPrimaryText">--</div>
                  <div class="bar-fill" id="enemyPrimaryBar" style="width: 100%;"></div>
                </div>
              </div>
              
            </div>

            <div class="controls">
              <button class="btn-primary" id="queueBtn">Enter the Arena</button>
              <button class="btn-primary" id="lockBtn">Lock In</button>
              <button id="passBtn">Pass Turn</button>
              
              <div class="input-group">
                <input id="commandInput" type="text" placeholder="Enter command..." autocomplete="off" />
                <button id="sendBtn">Execute</button>
              </div>
            </div>

            <div class="hint">
              <strong>Commands:</strong><br>
              <span class="kbd">/class warrior</span>, <span class="kbd">/class mage</span>, or <span class="kbd">/class rogue</span> - Choose your class<br>
              <span class="kbd">/item weapon steel_long_sword</span> - Equip weapon<br>
              <span class="kbd">/item armor leather_armor</span> - Equip armor<br>
              <span class="kbd">basic_attack</span>, <span class="kbd">fireball</span>, <span class="kbd">eviscerate</span>, <span class="kbd">blink</span>, <span class="kbd">cheap_shot</span> - Combat abilities<br>
              <br>
              <strong>Chat:</strong> Use the Chat box below to message your opponent
            </div>
          </div>
        </div>

        <!-- Right Panel: Combat Log & Chat -->
        <div class="panel">
          <div class="panel-header">Combat Chronicle</div>
          <div class="panel-body">
            <div id="log" class="combat-log"></div>
            
            <!-- Chat Section -->
            <div class="chat-section">
              <div class="chat-header">Chat</div>
              <div id="chatBox" class="chat-box"></div>
              <div class="chat-input-group">
                <input id="chatInput" type="text" placeholder="Type your message..." autocomplete="off" />
                <button id="chatSendBtn">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documentation -->
    <div class="documentation">
      <h2 class="doc-title">Champion's Codex</h2>

      <div class="doc-section">
        <h3>Classes</h3>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Warrior</h4>
            <p><span class="stat">Attack: 12</span> | <span class="stat">Intellect: 2</span> | <span class="stat">Defense: 8</span></p>
            <p><span class="stat">HP: 110</span> | Speed: 8 | Crit: 5% | Accuracy: 90%</p>
            <p>Master of physical combat. Excels at melee attacks and tanking damage. High HP and physical damage output.</p>
          </div>
          
          <div class="doc-item">
            <h4>Mage</h4>
            <p><span class="stat">Attack: 4</span> | <span class="stat">Intellect: 14</span> | <span class="stat">Defense: 4</span></p>
            <p><span class="stat">HP: 90</span> | <span class="stat">Mana: 80</span> | Speed: 9 | Crit: 8% | Accuracy: 95%</p>
            <p>Master of arcane magic. Weak physical attacks but devastating spells. Uses Mana for powerful abilities.</p>
          </div>

          <div class="doc-item">
            <h4>Rogue</h4>
            <p><span class="stat">Attack: 10</span> | <span class="stat">Intellect: 1</span> | <span class="stat">Defense: 4</span></p>
            <p><span class="stat">HP: 95</span> | <span class="stat">Energy: 100</span> | Speed: 9 | Crit: 8% | Accuracy: 97%</p>
            <p>Elusive striker with exceptional evasion. Uses Energy and excels at stealthy burst damage.</p>
          </div>
        </div>
      </div>

      <div class="doc-section">
        <h3>Weapons</h3>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Steel Long Sword</h4>
            <p><span class="stat">+5 Physical Attack</span></p>
            <p>A reliable blade forged in the fires of war. Ideal for Warriors.</p>
          </div>

          <div class="doc-item">
            <h4>Crusader's Greatsword</h4>
            <p><span class="stat">+4 Physical Attack</span> | <span class="stat">+2 Intellect</span></p>
            <p><span class="stat">Passive: 25% chance on hit to empower your next offensive ability (+20% damage)</span></p>
            <p>An epic blade that channels righteous fury into your next strike.</p>
          </div>
          
          <div class="doc-item">
            <h4>Spirit Light Sword</h4>
            <p><span class="stat">+3 Physical Attack</span></p>
            <p><span class="stat">Passive: Heal 3 HP every turn</span></p>
            <p>Blessed by the Light. Provides sustain through regeneration.</p>
          </div>
          
          <div class="doc-item">
            <h4>Wand of Fire</h4>
            <p><span class="stat">+6 Intellect</span></p>
            <p><span class="stat">Passive: Burn enemy for 2 HP/turn on hit</span></p>
            <p>Channels destructive flames. Burns enemies with every spell cast.</p>
          </div>
          
          <div class="doc-item">
            <h4>Staff of Immortality</h4>
            <p><span class="stat">+3 Intellect</span></p>
            <p><span class="stat">Passive: Heal 4 HP every turn</span></p>
            <p>Ancient artifact of life magic. Grants powerful regeneration.</p>
          </div>

          <div class="doc-item">
            <h4>Steel Daggers</h4>
            <p><span class="stat">+4 Physical Attack</span></p>
            <p><span class="stat">Passive: 25% chance to strike again for 40% damage</span></p>
            <p>Swift blades favored by rogues. Occasionally delivers a second strike.</p>
          </div>

          <div class="doc-item">
            <h4>Spear of Light</h4>
            <p><span class="stat">+3 Physical Attack</span> | <span class="stat">+3 Intellect</span></p>
            <p><span class="stat">Magic Resist: 2</span></p>
            <p>A radiant spear that balances martial prowess with arcane protection.</p>
          </div>

          <div class="doc-item">
            <h4>Void Blades</h4>
            <p><span class="stat">+3 Physical Attack</span> | <span class="stat">+2 Intellect</span></p>
            <p><span class="stat">Passive: Void Blade triggers extra magic damage (Intellect x0.4 + d4)</span></p>
            <p>Blades attuned to the abyss, calling forth void energy on successful hits.</p>
          </div>

          <div class="doc-item">
            <h4>Glock 19</h4>
            <p><span class="stat">+17 Physical Attack</span></p>
            <p><span class="stat">Passive: 55% chance to miss</span></p>
            <p>A risky firearm with devastating potential. High damage, unreliable aim.</p>
          </div>
        </div>
      </div>

      <div class="doc-section">
        <h3>Armor</h3>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Leather Armor</h4>
            <p><span class="stat">Physical Reduction: 3</span></p>
            <p><span class="stat">Magic Resist: 3</span></p>
            <p>Flexible protection. Reduces damage from all sources. Balanced defense.</p>
          </div>

          <div class="doc-item">
            <h4>Cloth Armor</h4>
            <p><span class="stat">Physical Reduction: 1</span></p>
            <p><span class="stat">Magic Resist: 5</span></p>
            <p>Lightweight cloth with strong enchantments. Great against spell damage.</p>
          </div>
          
          <div class="doc-item">
            <h4>Plate Armor</h4>
            <p><span class="stat">Physical Reduction: 6</span></p>
            <p><span class="stat">Magic Resist: 0</span></p>
            <p>Heavy steel plating. Exceptional physical protection but vulnerable to magic.</p>
          </div>
        </div>
      </div>

      <div class="doc-section">
        <h3>Trinkets</h3>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Focus Charm</h4>
            <p><span class="stat">+10 Mana</span></p>
            <p><span class="stat">Passive: Deal 10% more damage while above 70% HP</span></p>
            <p>Channel a steady focus to amplify spell and weapon damage.</p>
          </div>

          <div class="doc-item">
            <h4>Rage Crystal</h4>
            <p><span class="stat">+20 Rage</span></p>
            <p><span class="stat">Passive: Deal 15% more damage while below 30% HP</span></p>
            <p>A volatile crystal that empowers desperate finishing blows.</p>
          </div>
        </div>
      </div>

      <div class="doc-section">
        <h3>Abilities</h3>
        <h4 class="doc-subtitle">General</h4>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Basic Attack</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Type: Physical</span></p>
            <p><span class="stat">Command: <span class="kbd">basic_attack</span></span></p>
            <p>Standard melee attack. Damage scales with Attack stat. Roll d4 for power.</p>
          </div>

          <div class="doc-item">
            <h4>Defend</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 2</span></p>
            <p><span class="stat">Command: <span class="kbd">defend</span></span></p>
            <p>Defensive stance. Reduces incoming damage by 50% for 1 turn.</p>
          </div>
        </div>

        <h4 class="doc-subtitle">Warrior</h4>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Overpower</h4>
            <p><span class="stat">Cost: 0 Rage</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 1</span></p>
            <p><span class="stat">Command: <span class="kbd">overpower</span></span></p>
            <p>Weapon strike that scales with Attack (0.6x) and d4 power. Generates Rage equal to damage dealt.</p>
          </div>

          <div class="doc-item">
            <h4>Victory Rush</h4>
            <p><span class="stat">Cost: 0 Rage</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 20 (2 charges)</span></p>
            <p><span class="stat">Command: <span class="kbd">victory_rush</span></span></p>
            <p>Quick strike that scales with Attack (0.5x) and d2 power. Heals for Attack (2.2x) and d6 power on hit and generates 5 Rage.</p>
          </div>

          <div class="doc-item">
            <h4>Rampage</h4>
            <p><span class="stat">Cost: 15 Rage</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 0</span></p>
            <p><span class="stat">Command: <span class="kbd">rampage</span></span></p>
            <p>Rapidly strike twice. Each hit scales with Attack (0.7x) and d4 power.</p>
          </div>

          <div class="doc-item">
            <h4>Mortal Strike</h4>
            <p><span class="stat">Cost: 30 Rage</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 0</span></p>
            <p><span class="stat">Command: <span class="kbd">mortal_strike</span></span></p>
            <p>Massive blow. Scales with Attack (2.0x) and d6 power.</p>
          </div>

          <div class="doc-item">
            <h4>Execute</h4>
            <p><span class="stat">Cost: 20 Rage</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 1</span></p>
            <p><span class="stat">Command: <span class="kbd">execute</span></span></p>
            <p>Finishing strike that can only be used when the enemy is below 20% HP. Scales with Attack (1.5x) and d6 power.</p>
          </div>

          <div class="doc-item">
            <h4>Die by the Sword</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 10</span></p>
            <p><span class="stat">Command: <span class="kbd">die_by_sword</span></span></p>
            <p>Become immune to physical damage and reduce all incoming damage by 30% for 2 turns.</p>
          </div>
        </div>

        <h4 class="doc-subtitle">Mage</h4>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Fireball</h4>
            <p><span class="stat">Cost: 10 Mana</span> | <span class="stat">Type: Magic</span> | <span class="stat">Cooldown: 1</span></p>
            <p><span class="stat">Command: <span class="kbd">fireball</span></span></p>
            <p>Arcane blast. Damage scales with Intellect (0.4x) and d6 power. 15% chance to trigger Hot Streak.</p>
          </div>

          <div class="doc-item">
            <h4>Pyroblast</h4>
            <p><span class="stat">Cost: 20 Mana</span> | <span class="stat">Type: Magic</span> | <span class="stat">Cooldown: 0</span></p>
            <p><span class="stat">Command: <span class="kbd">pyroblast</span></span></p>
            <p>Devastating spell that requires Hot Streak. Scales with Intellect (2.0x) and d10 power.</p>
          </div>

          <div class="doc-item">
            <h4>Ring of Ice</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 3</span></p>
            <p><span class="stat">Command: <span class="kbd">ring_of_ice</span></span></p>
            <p>Freezes the enemy in place, stunning them for 1 turn.</p>
          </div>

          <div class="doc-item">
            <h4>Ice Block</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 20</span></p>
            <p><span class="stat">Command: <span class="kbd">iceblock</span></span></p>
            <p>Become immune to all damage for 3 turns. Restores 10 HP and 25 Mana each turn, but you cannot act.</p>
          </div>

          <div class="doc-item">
            <h4>Blink</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 6</span></p>
            <p><span class="stat">Command: <span class="kbd">blink</span></span></p>
            <p>Blinks away, causing enemy attacks to miss for the current and next turn.</p>
          </div>

          <div class="doc-item">
            <h4>Ice Barrier</h4>
            <p><span class="stat">Cost: 10 Mana</span> | <span class="stat">Cooldown: 15</span></p>
            <p><span class="stat">Command: <span class="kbd">ice_barrier</span></span></p>
            <p>Wrap yourself in a shield that absorbs damage based on Intellect (0.9x) plus a d6 roll.</p>
          </div>
        </div>

        <h4 class="doc-subtitle">Rogue</h4>
        <div class="doc-grid">
          <div class="doc-item">
            <h4>Cheap Shot</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 3</span></p>
            <p><span class="stat">Command: <span class="kbd">cheap_shot</span></span></p>
            <p>Stuns the enemy for 1 turn.</p>
          </div>

          <div class="doc-item">
            <h4>Kidney Shot</h4>
            <p><span class="stat">Cost: 5 Energy</span> | <span class="stat">Cooldown: 10</span></p>
            <p><span class="stat">Command: <span class="kbd">kidney_shot</span></span></p>
            <p>Stuns the enemy for 2 turns.</p>
          </div>

          <div class="doc-item">
            <h4>Vanish</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 15</span></p>
            <p><span class="stat">Command: <span class="kbd">vanish</span></span></p>
            <p>Enter Stealth for 3 turns, restoring 15 HP and 5 Energy each turn. Stealth breaks if you take more than 5 damage.</p>
          </div>

          <div class="doc-item">
            <h4>Eviscerate</h4>
            <p><span class="stat">Cost: 30 Energy</span> | <span class="stat">Type: Physical</span> | <span class="stat">Cooldown: 1</span></p>
            <p><span class="stat">Command: <span class="kbd">eviscerate</span></span></p>
            <p>Heavy strike that scales with Attack (1.2x) and d10 power.</p>
          </div>

          <div class="doc-item">
            <h4>Evasion</h4>
            <p><span class="stat">Cost: Free</span> | <span class="stat">Cooldown: 20</span></p>
            <p><span class="stat">Command: <span class="kbd">evasion</span></span></p>
            <p>Double your evasion for 2 turns while still allowing attacks.</p>
          </div>

          <div class="doc-item">
            <h4>Thistle Tea</h4>
            <p><span class="stat">Cost: 30 Energy</span> | <span class="stat">Cooldown: 15</span></p>
            <p><span class="stat">Command: <span class="kbd">thistle_tea</span></span></p>
            <p>Restore 30 Energy at the end of each turn for 3 turns.</p>
          </div>

          <div class="doc-item">
            <h4>Shadow Blade</h4>
            <p><span class="stat">Cost: 15 Energy</span> | <span class="stat">Type: Physical</span></p>
            <p><span class="stat">Command: <span class="kbd">shadow_blade</span></span></p>
            <p>Quick strike that scales with Attack (0.3x) and d6 power. While stealthed, it scales with Attack (1.0x) and d8 power. 20% chance to proc Ambush.</p>
          </div>

          <div class="doc-item">
            <h4>Ambush</h4>
            <p><span class="stat">Cost: 15 Energy</span> | <span class="stat">Type: Physical</span></p>
            <p><span class="stat">Command: <span class="kbd">ambush</span></span></p>
            <p>Powerful strike only usable after an Ambush proc. Scales with Attack (2.0x) and d6 power.</p>
          </div>
        </div>
      </div>

      <div class="doc-section">
        <h3>Combat Mechanics</h3>
        <div class="doc-content">
          <p><strong>Damage Types:</strong> Physical damage is reduced by Physical Reduction. Magic damage is reduced by Magic Resist.</p>
          
          <p><strong>Critical Hits:</strong> Each class has a crit chance. Critical hits deal 150% damage.</p>
          
          <p><strong>Accuracy & Evasion:</strong> Attacks can miss based on attacker's Accuracy vs defender's Evasion.</p>
          
          <p><strong>Damage over Time (DoT):</strong> Burn effects deal damage at the end of each turn. Burns refresh but do not stack.</p>
          
          <p><strong>Passive Healing:</strong> Spirit Light Sword and Staff of Immortality heal automatically at turn end.</p>
          
          <p><strong>Resource Regeneration:</strong> Mana regenerates 2 per turn. Energy regenerates 5 per turn.</p>

          <p><strong>Stealth:</strong> Stealthed targets cannot be hit until they attack or take more than 5 damage.</p>
        </div>
      </div>

      <div class="doc-section">
        <h3>How to Play</h3>
        <div class="doc-content">
          <p><strong>1. Join Queue:</strong> Click "Enter the Arena" to find an opponent.</p>
          
          <p><strong>2. Prep Phase:</strong> Choose your class with <span class="kbd">/class warrior</span>, <span class="kbd">/class mage</span>, or <span class="kbd">/class rogue</span></p>
          
          <p><strong>3. Equip Items:</strong> Use <span class="kbd">/item weapon steel_long_sword</span> and <span class="kbd">/item armor plate_armor</span></p>
          
          <p><strong>4. Combat:</strong> Type ability names like <span class="kbd">basic_attack</span> or <span class="kbd">fireball</span> to attack each turn.</p>
          
          <p><strong>5. Victory:</strong> Reduce enemy HP to 0 to win. Last champion standing wins!</p>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
      const logDiv = document.getElementById("log");
      const cmdInput = document.getElementById("commandInput");
      const sendBtn = document.getElementById("sendBtn");
      const queueBtn = document.getElementById("queueBtn");
      const chatBox = document.getElementById("chatBox");
      const chatInput = document.getElementById("chatInput");
      const chatSendBtn = document.getElementById("chatSendBtn");

      const connDot = document.getElementById("connDot");
      const connText = document.getElementById("connText");
      const roleText = document.getElementById("roleText");
      const friendlyLabel = document.getElementById("friendlyLabel");
      const enemyLabel = document.getElementById("enemyLabel");
      
      const friendlyHpText = document.getElementById("friendlyHpText");
      const friendlyHpBar = document.getElementById("friendlyHpBar");
      const friendlyAbsorbBar = document.getElementById("friendlyAbsorbBar");
      const friendlyPrimaryLabel = document.getElementById("friendlyPrimaryLabel");
      const friendlyPrimaryText = document.getElementById("friendlyPrimaryText");
      const friendlyPrimaryBar = document.getElementById("friendlyPrimaryBar");
      const friendlyWeapon = document.getElementById("friendlyWeapon");
      const friendlyArmor = document.getElementById("friendlyArmor");
      const friendlyTrinket = document.getElementById("friendlyTrinket");
      const friendlyStatus = document.getElementById("friendlyStatus");
      
      const enemyHpText = document.getElementById("enemyHpText");
      const enemyHpBar = document.getElementById("enemyHpBar");
      const enemyAbsorbBar = document.getElementById("enemyAbsorbBar");
      const enemyPrimaryLabel = document.getElementById("enemyPrimaryLabel");
      const enemyPrimaryText = document.getElementById("enemyPrimaryText");
      const enemyPrimaryBar = document.getElementById("enemyPrimaryBar");
      const enemyWeapon = document.getElementById("enemyWeapon");
      const enemyArmor = document.getElementById("enemyArmor");
      const enemyTrinket = document.getElementById("enemyTrinket");
      const enemyStatus = document.getElementById("enemyStatus");
      const lockBtn = document.getElementById("lockBtn");
      const passBtn = document.getElementById("passBtn");

      const socket = io();
      let myRole = null;

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeRegExp(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      const warriorAbilities = [
        "Overpower",
        "Victory Rush",
        "Rampage",
        "Mortal Strike",
        "Execute",
        "Die by the Sword",
      ];
      const mageAbilities = [
        "Fireball",
        "Pyroblast",
        "Ice Block",
        "Ring of Ice",
        "Blink",
        "Ice Barrier",
      ];
      const rogueAbilities = [
        "Cheap Shot",
        "Kidney Shot",
        "Vanish",
        "Eviscerate",
        "Evasion",
        "Shadow Blade",
        "Ambush",
        "Thistle Tea",
      ];
      const greenItems = [
        "Steel Long Sword",
        "Wand of Fire",
        "Plate Armor",
        "Steel Daggers",
        "Cloth Armor",
      ];
      const blueItems = [
        "Spirit Light Sword",
        "Staff of Immortality",
        "Leather Armor",
        "Focus Charm",
        "Rage Crystal",
        "Spear of Light",
      ];
      const purpleItems = [
        "Glock 19",
        "Void Blades",
        "Crusader's Greatsword",
      ];

      function itemClassForName(name) {
        if (!name) {
          return "";
        }
        if (greenItems.includes(name)) {
          return "log-item-green";
        }
        if (blueItems.includes(name)) {
          return "log-item-blue";
        }
        if (purpleItems.includes(name)) {
          return "log-item-purple";
        }
        return "";
      }

      function setItemLabel(element, name) {
        element.textContent = name || "--";
        element.classList.remove("log-item-green", "log-item-blue", "log-item-purple");
        const itemClass = itemClassForName(name);
        if (itemClass) {
          element.classList.add(itemClass);
        }
      }

      function highlightLogLine(text) {
        if (text.includes("HOT STREAK") || text.includes("Can Use Execute")) {
          return escapeHtml(text);
        }
        if (text.includes("Has Ambush!")) {
          return escapeHtml(text);
        }

        let output = escapeHtml(text);
        const classPatterns = [
          { pattern: /\bWarrior(\(you\))?\b/g, className: "log-class-warrior" },
          { pattern: /\bMage(\(you\))?\b/g, className: "log-class-mage" },
          { pattern: /\bRogue(\(you\))?\b/g, className: "log-class-rogue" },
        ];
        classPatterns.forEach(({ pattern, className }) => {
          output = output.replace(pattern, `<span class="${className}">$&</span>`);
        });

        warriorAbilities.forEach((ability) => {
          const pattern = new RegExp(`\\b${escapeRegExp(ability)}\\b`, "g");
          output = output.replace(pattern, `<span class="log-ability-warrior">$&</span>`);
        });
        mageAbilities.forEach((ability) => {
          const pattern = new RegExp(`\\b${escapeRegExp(ability)}\\b`, "g");
          output = output.replace(pattern, `<span class="log-ability-mage">$&</span>`);
        });
        rogueAbilities.forEach((ability) => {
          const pattern = new RegExp(`\\b${escapeRegExp(ability)}\\b`, "g");
          output = output.replace(pattern, `<span class="log-ability-rogue">$&</span>`);
        });
        greenItems.forEach((item) => {
          const escapedItem = escapeRegExp(item).replace(/'/g, "(?:'|&#039;)");
          const pattern = new RegExp(`\\b${escapedItem}\\b`, "g");
          output = output.replace(pattern, `<span class="log-item-green">$&</span>`);
        });
        blueItems.forEach((item) => {
          const escapedItem = escapeRegExp(item).replace(/'/g, "(?:'|&#039;)");
          const pattern = new RegExp(`\\b${escapedItem}\\b`, "g");
          output = output.replace(pattern, `<span class="log-item-blue">$&</span>`);
        });
        purpleItems.forEach((item) => {
          const escapedItem = escapeRegExp(item).replace(/'/g, "(?:'|&#039;)");
          const pattern = new RegExp(`\\b${escapedItem}\\b`, "g");
          output = output.replace(pattern, `<span class="log-item-purple">$&</span>`);
        });

        return output;
      }

      function appendLine(msg, cls = "") {
        const line = document.createElement("div");
        const classes = ['log-line'];
        if (cls) {
          classes.push(cls);
        }
        if (msg.includes("HOT STREAK")) {
          classes.push("logLineProc");
        }
        if (msg.includes("Has Ambush!")) {
          classes.push("logLineAmbush");
        }
        if (msg.includes("Can Use Execute")) {
          classes.push("logLineExecute");
        }
        if (msg.startsWith("Turn ")) {
          classes.push("logLineTurnHeader");
        }
        if (msg.includes("wins the duel") || msg.includes("Double KO")) {
          classes.push("logLineOutcome");
        }
        line.className = classes.join(" ");
        line.innerHTML = highlightLogLine(msg);
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function appendChatMessage(playerClass, message, isMe) {
        const msgDiv = document.createElement("div");
        msgDiv.className = isMe ? 'chat-message friendly' : 'chat-message enemy';
        
        const playerSpan = document.createElement("span");
        playerSpan.className = 'chat-player';
        playerSpan.textContent = playerClass + (isMe ? " (YOU):" : ":");
        
        const textSpan = document.createElement("span");
        textSpan.textContent = " " + message;
        
        msgDiv.appendChild(playerSpan);
        msgDiv.appendChild(textSpan);
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      socket.on("connect", () => {
        lastLogLength = 0;
        connDot.classList.add("connected");
        connText.textContent = "Connected";
        appendLine("‚öîÔ∏è Connected to Arena Server", "logLineSystem");
      });

      socket.on("disconnect", () => {
        lastLogLength = 0;
        connDot.classList.remove("connected");
        connText.textContent = "Disconnected";
        roleText.textContent = "Awaiting Match";
        appendLine("‚ùå Disconnected from Arena Server", "logLineSystem");
      });

      socket.on("duel_system", (msg) => appendLine("üõ°Ô∏è " + msg, "logLineSystem"));
      socket.on("duel_role", (role) => {
        myRole = role;
        roleText.textContent = role;
        appendLine("‚öîÔ∏è You are " + role, "logLineSystem");
      });
      
      socket.on("duel_chat", (data) => {
        // data should have: playerClass, message, role
        const isMe = (data.role === myRole);
        appendChatMessage(data.playerClass, data.message, isMe);
      });
      socket.on("duel_prep_options", (data) => {
        if (data?.classes) {
          appendLine("üìú Classes: " + Object.keys(data.classes).join(", "), "logLineSystem");
        }
        if (data?.items) {
          appendLine("‚öíÔ∏è Items: " + Object.keys(data.items).join(", "), "logLineSystem");
        }
        if (data?.abilities) {
          appendLine("‚ú® Abilities: " + Object.keys(data.abilities).join(", "), "logLineSystem");
        }
      });

      socket.on("duel_turn", (msg) => {
        appendLine(" ", "logLineTurn");
        msg.split("\n").forEach(line => appendLine(line, "logLineTurn"));
      });

      socket.on("duel_log", (msg) => appendLine(msg, "logLineTurn"));
      
      let lastLogLength = 0;
      socket.on("duel_snapshot", (data) => {
        // Update class names
        if (data.you_class) {
          friendlyLabel.textContent = data.you_class;
        }
        if (data.enemy_class) {
          enemyLabel.textContent = data.enemy_class;
        }
        
        // Update equipped items
        if (data.you_items) {
          setItemLabel(friendlyWeapon, data.you_items.weapon);
          setItemLabel(friendlyArmor, data.you_items.armor);
          setItemLabel(friendlyTrinket, data.you_items.trinket);
        }
        if (data.enemy_items) {
          setItemLabel(enemyWeapon, data.enemy_items.weapon);
          setItemLabel(enemyArmor, data.enemy_items.armor);
          setItemLabel(enemyTrinket, data.enemy_items.trinket);
        }
        
      function primaryResourceFrom(res, resource) {
        if (!resource || !res) {
          return { value: 0, max: 0 };
        }
        const map = {
          mp: { value: res.mp, max: res.mp_max },
          rage: { value: res.rage, max: res.rage_max },
          energy: { value: res.energy, max: res.energy_max },
        };
        return map[resource.id] || { value: res.mp, max: res.mp_max };
      }

      function renderRes(res, elements, resource) {
        if (!res) {
          elements.hpText.textContent = "--";
          elements.hpBar.style.width = "0%";
          if (elements.absorbBar) {
            elements.absorbBar.style.width = "0%";
          }
          elements.primaryText.textContent = "--";
          elements.primaryBar.style.width = "0%";
          return;
        }
        
        const clampedHp = Math.max(0, Math.min(res.hp, res.hp_max));
        const hpPercent = res.hp_max ? (clampedHp / res.hp_max) * 100 : 0;
        const absorbValue = Math.max(0, res.absorb || 0);
        const absorbPercent = res.hp_max ? (absorbValue / res.hp_max) * 100 : 0;
        const absorbWidth = Math.min(absorbPercent, Math.max(0, 100 - hpPercent));
        const primaryResource = primaryResourceFrom(res, resource);
        const primaryPercent = primaryResource.max ? (primaryResource.value / primaryResource.max) * 100 : 0;
        
        elements.hpText.textContent = `${res.hp} / ${res.hp_max}`;
        const isDead = res.hp <= 0;
        elements.hpBar.classList.toggle("hp-dead", isDead);
        elements.hpBar.style.width = isDead ? "100%" : hpPercent + "%";
        if (elements.absorbBar) {
          elements.absorbBar.style.width = isDead ? "0%" : absorbWidth + "%";
        }
        elements.primaryText.textContent = `${primaryResource.value} / ${primaryResource.max}`;
        elements.primaryBar.style.width = primaryPercent + "%";
        elements.primaryLabel.textContent = resource.label || "Mana";
        elements.primaryLabel.style.color = resource.color || "var(--mana-blue)";
        elements.primaryBar.style.backgroundColor = resource.color || "var(--mana-blue)";
      }

      function renderStatus(stealthed, element) {
        if (!element) return;
        if (stealthed) {
          element.textContent = "Stealthed";
          element.classList.add("stealthed");
        } else {
          element.textContent = "--";
          element.classList.remove("stealthed");
        }
      }
      
        renderRes(data.you, {
          hpText: friendlyHpText,
          hpBar: friendlyHpBar,
          absorbBar: friendlyAbsorbBar,
          primaryText: friendlyPrimaryText,
          primaryBar: friendlyPrimaryBar,
          primaryLabel: friendlyPrimaryLabel,
        }, data.you_resource || { id: "mp", label: "Mana", color: "var(--mana-blue)" });
        renderStatus(Boolean(data.you_stealthed), friendlyStatus);
        
        renderRes(data.enemy, {
          hpText: enemyHpText,
          hpBar: enemyHpBar,
          absorbBar: enemyAbsorbBar,
          primaryText: enemyPrimaryText,
          primaryBar: enemyPrimaryBar,
          primaryLabel: enemyPrimaryLabel,
        }, data.enemy_resource || { id: "mp", label: "Mana", color: "var(--mana-blue)" });
        renderStatus(Boolean(data.enemy_stealthed), enemyStatus);
        
        if (data.log) {
          const total = data.log_length ?? data.log.length;
          const newCount = Math.max(total - lastLogLength, 0);
          const sliceStart = data.log.length - newCount;
          data.log.slice(sliceStart).forEach(line => appendLine(line, "logLineTurn"));
          lastLogLength = total;
        }
        
        if (data.phase === "ended") {
          appendLine("üèÜ DUEL ENDED!", "logLineSystem");
        }

        lockBtn.disabled = data.phase !== "prep";
      });

      function sendCommand() {
        const text = cmdInput.value.trim();
        if (!text) return;

        if (text.toLowerCase().startsWith("/class")) {
          const parts = text.split(/\s+/);
          const classId = (parts[1] || "").toLowerCase();
          socket.emit("duel_prep_submit", { class_id: classId });
        } else if (text.toLowerCase().startsWith("/item")) {
          const parts = text.split(/\s+/);
          const slot = parts[1] || "";
          const itemId = parts[2] || "";
          if (slot && itemId) {
            socket.emit("duel_prep_submit", { items: { [slot]: itemId } });
          }
        } else {
          socket.emit("duel_action", { ability_id: text.toLowerCase() });
        }

        cmdInput.value = "";
      }

      function sendChat() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        socket.emit("duel_chat", text);
        chatInput.value = "";
      }

      sendBtn.addEventListener("click", sendCommand);
      cmdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendCommand();
        }
      });

      chatSendBtn.addEventListener("click", sendChat);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendChat();
        }
      });

      queueBtn.addEventListener("click", () => socket.emit("duel_queue"));
      lockBtn.addEventListener("click", () => socket.emit("duel_lock_in"));
      passBtn.addEventListener("click", () => socket.emit("duel_action", { ability_id: "pass_turn" }));
    </script>
  </body>
</html>
